name: Build Multi-Platform

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.29.0'

jobs:
  # Android APK
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build APK
        run: flutter build apk --release
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  # iOS IPA
  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign
      
      - name: Create IPA
        run: |
          mkdir -p Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          zip -r app-release.ipa Payload
      
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: app-release.ipa

  # Windows EXE 安装包
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Windows
        run: flutter build windows --release
      
      - name: Create Inno Setup script
        run: |
          @"
          [Setup]
          AppName=喵王语录
          AppVersion=1.0.0
          AppPublisher=MeowBiu
          DefaultDirName={autopf}\MiaowangYulu
          DefaultGroupName=喵王语录
          OutputDir=.
          OutputBaseFilename=miaowang-windows-setup
          Compression=lzma
          SolidCompression=yes
          SetupIconFile=windows\runner\resources\app_icon.ico
          UninstallDisplayIcon={app}\miaowang.exe
          ArchitecturesInstallIn64BitMode=x64compatible
          
          [Languages]
          Name: "chinesesimplified"; MessagesFile: "compiler:Languages\ChineseSimplified.isl"
          Name: "english"; MessagesFile: "compiler:Default.isl"
          
          [Tasks]
          Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked
          
          [Files]
          Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs
          
          [Icons]
          Name: "{group}\喵王语录"; Filename: "{app}\miaowang.exe"
          Name: "{group}\卸载喵王语录"; Filename: "{uninstallexe}"
          Name: "{autodesktop}\喵王语录"; Filename: "{app}\miaowang.exe"; Tasks: desktopicon
          
          [Run]
          Filename: "{app}\miaowang.exe"; Description: "{cm:LaunchProgram,喵王语录}"; Flags: nowait postinstall skipifsilent
          "@ | Out-File -FilePath setup.iss -Encoding UTF8
      
      - name: Build installer
        run: iscc setup.iss
      
      - name: Upload Windows EXE
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: miaowang-windows-setup.exe

  # Linux
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Linux
        run: flutter build linux --release
      
      - name: Create tarball
        run: tar -czvf linux-release.tar.gz -C build/linux/x64/release/bundle .
      
      - name: Upload Linux
        uses: actions/upload-artifact@v4
        with:
          name: linux-tar
          path: linux-release.tar.gz

  # macOS
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build macOS
        run: flutter build macos --release
      
      - name: Create DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "喵王语录" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "miaowang-macos.dmg" \
            "build/macos/Build/Products/Release/喵王语录.app" || true
          # 如果 create-dmg 失败，回退到 zip
          if [ ! -f "miaowang-macos.dmg" ]; then
            cd build/macos/Build/Products/Release
            zip -r ../../../../../macos-release.zip *.app
            cd ../../../../..
          fi
      
      - name: Upload macOS
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: |
            miaowang-macos.dmg
            macos-release.zip
          if-no-files-found: warn

  # 创建 Release
  create-release:
    needs: [build-android, build-ios, build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure
        run: ls -R artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/android-apk/app-release.apk
            artifacts/ios-ipa/app-release.ipa
            artifacts/windows-exe/miaowang-windows-setup.exe
            artifacts/linux-tar/linux-release.tar.gz
            artifacts/macos-app/*
          draft: false
          prerelease: false
          generate_release_notes: true
